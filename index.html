<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexHome Masdar V6.8</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0b1120; --accent: #38bdf8; --card-bg: rgba(30, 41, 59, 0.6); }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #f8fafc; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        .glass { background: var(--card-bg); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        .tab-content { display: none; flex: 1; overflow: hidden; width: 100%; position: relative; }
        .tab-content.active { display: flex; flex-direction: column; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Chat History Area */
        .chat-scroll-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 20px; font-size: 13px; line-height: 1.5; animation: fadeIn 0.3s ease-out; }
        .chat-ai { background: rgba(30, 41, 59, 0.9); border: 1px solid rgba(56, 189, 248, 0.2); align-self: flex-start; border-bottom-left-radius: 4px; color: #f1f5f9; }
        .chat-user { background: #2563eb; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }

        /* FIXED INPUT AREA - Always above Nav */
        .ai-controls { padding: 12px 16px 16px; background: linear-gradient(to top, var(--bg) 80%, transparent); border-top: 1px solid rgba(255,255,255,0.05); }
        .input-bar { background: #1e293b; padding: 6px; display: flex; align-items: center; gap: 8px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 -10px 25px rgba(0,0,0,0.2); }
        .input-field { flex: 1; background: transparent; border: none; padding: 10px 14px; color: white; font-size: 14px; outline: none; }
        
        .btn-circle { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.3s; shrink-0; }
        .btn-mic { background: #38bdf8; color: #0f172a; }
        .btn-mic.listening { background: #ef4444; animation: pulse-red 1.5s infinite; color: white; }
        .btn-send { color: #38bdf8; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); } 70% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Auth */
        #login-screen { position: fixed; inset: 0; background: #0b1120; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pin-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #38bdf8; margin: 0 8px; }
        .pin-dot.filled { background: #38bdf8; box-shadow: 0 0 12px #38bdf8; }
    </style>
</head>
<body>

    <!-- Pin Screen -->
    <div id="login-screen">
        <div class="mb-10 text-center">
            <h1 class="text-2xl font-black italic uppercase text-white">NexHome <span class="text-blue-400">Masdar</span></h1>
            <p class="text-slate-500 text-[9px] mt-2 uppercase tracking-[0.4em] font-bold">Secure Access V6.8</p>
        </div>
        <div class="flex mb-16" id="pin-display">
            <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
        </div>
        <div class="grid grid-cols-3 gap-6">
            <script>
                for(let i=1; i<=9; i++) document.write(`<button onclick="handlePin('${i}')" class="w-16 h-16 rounded-full glass text-xl font-bold active:bg-blue-500/20 text-white">${i}</button>`);
                document.write(`<div></div><button onclick="handlePin('0')" class="w-16 h-16 rounded-full glass text-xl font-bold active:bg-blue-500/20 text-white">0</button><button onclick="resetPin()" class="text-red-500 text-[10px] font-black uppercase">Reset</button>`);
            </script>
        </div>
    </div>

    <!-- Header -->
    <div class="glass border-b border-white/5 sticky top-0 z-[500]">
        <header class="p-4 flex justify-between items-center">
            <div class="flex flex-col">
                <h1 class="text-xs font-black italic uppercase text-white leading-none">NexHome <span class="text-blue-400">Masdar</span></h1>
                <div class="flex items-center gap-1.5 mt-2">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span id="clock" class="text-[10px] font-bold text-slate-400">--:--:--</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right">
                    <p id="header-temp" class="text-xs font-bold text-white">--째C</p>
                    <p class="text-[7px] font-black uppercase text-blue-400">Status Awan</p>
                </div>
                <button onclick="toggleEco()" id="eco-badge" class="px-3 py-1.5 rounded-full text-[8px] font-black border border-white/10 uppercase">ECO: --</button>
            </div>
        </header>
        <div class="px-4 pb-3">
            <div id="log-box" class="h-14 overflow-y-auto scrollbar-hide text-[9px] text-slate-500 bg-black/20 rounded-lg p-2 border border-white/5">
                <div id="log-list">Menunggu data...</div>
            </div>
        </div>
    </div>

    <main class="flex-1 relative overflow-hidden flex flex-col">
        <!-- AI INTERFACE -->
        <div id="tab-ai" class="tab-content active h-full flex flex-col">
            <!-- Scrollable Chat -->
            <div id="chat-box" class="chat-scroll-area scrollbar-hide">
                <div class="chat-bubble chat-ai">
                    Sistem Masdar V6.8 siap. Silakan berikan perintah lewat suara atau ketikan.
                </div>
            </div>
            
            <!-- Fixed AI Controls -->
            <div class="ai-controls">
                <div class="input-bar">
                    <button id="btn-mic" onclick="runVoice()" class="btn-circle btn-mic">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                    </button>
                    <input type="text" id="chat-input" class="input-field" placeholder="Perintahkan AI..." onkeypress="if(event.key==='Enter') sendText()">
                    <button onclick="sendText()" class="btn-circle btn-send">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div id="tab-dash" class="tab-content p-4 space-y-4 overflow-y-auto scrollbar-hide">
            <div class="grid grid-cols-2 gap-3">
                <div class="glass p-4 rounded-3xl">
                    <p class="text-[8px] font-bold text-slate-500 uppercase mb-2">Suhu Ambien</p>
                    <div class="flex justify-between items-end">
                        <span class="text-2xl font-black" id="d-temp">--</span>
                        <span class="text-xs font-bold text-blue-400" id="d-hum">--%</span>
                    </div>
                </div>
                <div class="glass p-4 rounded-3xl">
                    <p class="text-[8px] font-bold text-slate-500 uppercase mb-2">Partikel Udara</p>
                    <p id="d-air-txt" class="text-sm font-black text-emerald-400 uppercase">--</p>
                    <p class="text-[8px] text-slate-500 mt-1 font-bold" id="d-air-val">-- PPM</p>
                </div>
            </div>
            <div class="glass p-6 rounded-[2.5rem] relative overflow-hidden h-36 flex flex-col justify-end">
                <p class="text-[8px] font-black text-slate-500 uppercase absolute top-6 left-6">Level Tandon</p>
                <p class="text-4xl font-black text-white"><span id="d-water">--</span><span class="text-blue-400 text-lg ml-1">%</span></p>
                <div id="water-fill" class="absolute bottom-0 left-0 right-0 bg-blue-500/30 transition-all duration-1000" style="height: 0%"></div>
            </div>
        </div>

        <!-- CONTROLS -->
        <div id="tab-ctrl" class="tab-content p-4 overflow-y-auto scrollbar-hide pb-32">
            <div id="pintu-card" onclick="triggerPintu()" class="glass p-5 rounded-3xl border-l-4 mb-4 flex justify-between items-center transition-all">
                <div>
                    <p class="text-[10px] font-black text-white uppercase">Sistem Keamanan Pintu</p>
                    <p id="pintu-txt" class="text-[8px] font-bold uppercase mt-1">Status: Memuat...</p>
                </div>
                <div id="pintu-icon" class="w-10 h-10 rounded-full flex items-center justify-center bg-slate-900 border border-white/5"></div>
            </div>
            <div id="switch-grid" class="grid grid-cols-2 gap-3"></div>
        </div>
    </main>

    <!-- Navigation -->
    <nav class="glass h-20 flex items-center justify-around px-4 pb-4 z-[1000] rounded-t-[2.5rem]">
        <button onclick="changeTab('ai')" id="n-ai" class="flex flex-col items-center gap-1 text-blue-400">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <span class="text-[7px] font-black uppercase tracking-widest">AI</span>
        </button>
        <button onclick="changeTab('dash')" id="n-dash" class="flex flex-col items-center gap-1 text-slate-600">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
            <span class="text-[7px] font-black uppercase tracking-widest">Dash</span>
        </button>
        <button onclick="changeTab('ctrl')" id="n-ctrl" class="flex flex-col items-center gap-1 text-slate-600">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="7" width="20" height="15" rx="2" ry="2"/><polyline points="17 2 12 7 7 2"/></svg>
            <span class="text-[7px] font-black uppercase tracking-widest">Ctrl</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCVY-tSDQvob6kYB8-ebLMNVb3Rge1mtx8",
            authDomain: "smart-home-masdar.firebaseapp.com",
            projectId: "smart-home-masdar",
            databaseURL: "https://smart-home-masdar-default-rtdb.asia-southeast1.firebasedatabase.app/" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const rootRef = ref(db, "nexhome_v3");

        let state = {}, sens = {}, nm = {}, lastState = {};
        const synth = window.speechSynthesis;

        // --- Log Engine ---
        function writeLog(msg, isAlert = false) {
            const list = document.getElementById('log-list');
            const row = document.createElement('div');
            const time = new Date().toLocaleTimeString('id-ID', { hour12: false });
            row.innerHTML = `<span class="${isAlert?'text-red-400':'text-blue-400'}">[${time}]</span> ${msg}`;
            list.prepend(row);
            if(list.children.length > 20) list.lastChild.remove();
        }

        // --- Firebase Data Listener ---
        onValue(rootRef, snap => {
            const data = snap.val() || {};
            const ns = data.states || {};
            sens = data.sensors || {};
            nm = data.names || {};

            if (Object.keys(lastState).length > 0) {
                for(let i=1; i<=8; i++) {
                    const id = `relay${i}`;
                    if(ns[id] !== lastState[id]) writeLog(`${nm[id] || id}: ${ns[id]?'NYALA':'MATI'}`);
                }
                if(ns.door !== lastState.door) writeLog(`Akses Pintu: ${ns.door?'DIBUKA':'DIKUNCI'}`, ns.door);
            }

            state = ns;
            lastState = JSON.parse(JSON.stringify(ns));
            renderUI();
        });

        function renderUI() {
            document.getElementById('header-temp').innerText = `${sens.temperature || '--'}째C`;
            document.getElementById('d-temp').innerText = `${sens.temperature || '--'}째`;
            document.getElementById('d-hum').innerText = `${sens.humidity || '--'}%`;
            document.getElementById('d-air-val').innerText = `${sens.air_quality || '0'} PPM`;
            document.getElementById('d-water').innerText = sens.water_level || '0';
            document.getElementById('water-fill').style.height = `${sens.water_level || 0}%`;

            const aq = sens.air_quality || 0;
            const aqT = document.getElementById('d-air-txt');
            if(aq > 150) { aqT.innerText = "KUALITAS BURUK"; aqT.className = "text-sm font-black text-red-500 uppercase"; }
            else { aqT.innerText = "KUALITAS SEHAT"; aqT.className = "text-sm font-black text-emerald-400 uppercase"; }

            const dOpen = state.door === true;
            const pCard = document.getElementById('pintu-card');
            const pTxt = document.getElementById('pintu-txt');
            const pIco = document.getElementById('pintu-icon');
            pCard.className = `glass p-5 rounded-3xl border-l-4 ${dOpen ? 'border-red-500 bg-red-500/5' : 'border-emerald-500'} mb-4 flex justify-between items-center`;
            pTxt.innerText = dOpen ? "Status: Akses Terbuka" : "Status: Terkunci Aman";
            pTxt.className = `text-[8px] font-bold ${dOpen?'text-red-400':'text-emerald-400'} uppercase mt-1`;
            pIco.className = `w-10 h-10 rounded-full flex items-center justify-center bg-slate-900 border border-white/5 ${dOpen?'text-red-400':'text-emerald-400'}`;
            pIco.innerHTML = dOpen ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>` : `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`;

            const isEco = state.eco_mode === true;
            const eb = document.getElementById('eco-badge');
            eb.innerText = `ECO: ${isEco ? 'ON' : 'OFF'}`;
            eb.className = `px-3 py-1.5 rounded-full text-[8px] font-black border uppercase ${isEco ? 'bg-emerald-500/20 border-emerald-500 text-emerald-500' : 'border-white/10 text-slate-500'}`;

            const grid = document.getElementById('switch-grid');
            grid.innerHTML = '';
            for(let i=1; i<=8; i++) {
                const id = `relay${i}`, isOn = state[id] === true;
                const name = nm[id] || `Saklar ${i}`;
                const card = document.createElement('div');
                card.className = `glass p-4 rounded-3xl border-l-4 transition-all active:scale-95 ${isOn ? 'border-blue-500 bg-blue-600/10' : 'border-slate-800'}`;
                card.innerHTML = `<p class="text-[9px] font-black text-white uppercase truncate">${name}</p>
                    <div class="flex justify-between items-center mt-3"><span class="text-[7px] font-bold text-slate-600">CH-${i}</span>
                    <div class="w-7 h-4 bg-slate-950 rounded-full relative"><div class="absolute w-2.5 h-2.5 bg-white rounded-full top-0.5 transition-all ${isOn ? 'right-0.5 bg-blue-400' : 'left-0.5'}"></div></div></div>`;
                card.onclick = () => set(ref(db, `nexhome_v3/states/${id}`), !isOn);
                grid.appendChild(card);
            }
        }

        // --- ADVANCED AI LOGIC ---
        function processCommand(text) {
            const raw = text.toLowerCase();
            let reply = "";
            let handled = false;

            // Clear Input Bar Immediately
            document.getElementById('chat-input').value = "";

            if (raw.includes("status") || raw.includes("lapor")) {
                reply = `Kondisi Masdar: Suhu ${sens.temperature}째C, Udara ${sens.air_quality < 100 ? 'Sehat' : 'Terpolusi'}, Tandon ${sens.water_level}%.`;
                handled = true;
            }

            if (!handled && (raw.includes("semua") || raw.includes("seluruh"))) {
                const turnOn = raw.includes("nyala") || raw.includes("hidup") || raw.includes("on");
                const batch = {};
                for(let i=1; i<=8; i++) batch[`nexhome_v3/states/relay${i}`] = turnOn;
                update(ref(db), batch);
                reply = `Okey, sistem telah ${turnOn ? 'menyalakan' : 'mematikan'} semua saklar.`;
                handled = true;
            }

            if (!handled) {
                for(let i=1; i<=8; i++) {
                    const id = `relay${i}`;
                    const customName = (nm[id] || "").toLowerCase();
                    if ( (customName && raw.includes(customName)) || raw.includes(`saklar ${i}`) ) {
                        const turnOn = raw.includes("nyala") || raw.includes("hidup") || raw.includes("on") || !raw.includes("mati");
                        set(ref(db, `nexhome_v3/states/${id}`), turnOn);
                        reply = `Siap, ${nm[id] || `Saklar ${i}`} sudah saya ${turnOn ? 'nyalakan' : 'matikan'}.`;
                        handled = true;
                        break;
                    }
                }
            }

            if (!handled && raw.includes("pintu")) {
                const open = raw.includes("buka");
                set(ref(db, "nexhome_v3/states/door"), open);
                reply = open ? "Pintu utama telah dibuka aksesnya." : "Pintu utama telah dikunci rapat.";
                handled = true;
            }

            if (!handled) reply = "Perintah tidak terdaftar di memori saya, Masdar.";

            addBubble(reply, 'ai');
            speak(reply);
        }

        // --- Input Controls ---
        window.sendText = () => {
            const el = document.getElementById('chat-input');
            const val = el.value.trim();
            if(!val) return;
            addBubble(val, 'user');
            processCommand(val);
        };

        window.runVoice = () => {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!Speech) return writeLog("Browser tak dukung suara", true);
            const rec = new Speech();
            rec.lang = 'id-ID';
            const b = document.getElementById('btn-mic');
            rec.onstart = () => b.classList.add('listening');
            rec.onend = () => b.classList.remove('listening');
            rec.onresult = (e) => {
                const t = e.results[0][0].transcript;
                addBubble(t, 'user');
                processCommand(t);
            };
            rec.start();
        };

        function addBubble(text, role) {
            const box = document.getElementById('chat-box');
            const d = document.createElement('div');
            d.className = `chat-bubble chat-${role}`;
            d.innerText = text;
            box.appendChild(d);
            // Scroll to bottom
            box.scrollTop = box.scrollHeight;
        }

        function speak(t) {
            synth.cancel();
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'id-ID';
            synth.speak(u);
        }

        // --- UI Utils ---
        let currentPin = "";
        window.handlePin = (n) => {
            if(currentPin.length < 4) {
                currentPin += n;
                document.querySelectorAll('.pin-dot')[currentPin.length-1].classList.add('filled');
                if(currentPin.length === 4) {
                    setTimeout(() => {
                        if(currentPin === "1234") document.getElementById('login-screen').style.display = 'none';
                        else resetPin();
                    }, 300);
                }
            }
        };
        window.resetPin = () => { currentPin = ""; document.querySelectorAll('.pin-dot').forEach(d => d.classList.remove('filled')); };
        
        window.changeTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            ['ai','dash','ctrl'].forEach(t => {
                document.getElementById(`n-${t}`).className = `flex flex-col items-center gap-1 ${id===t?'text-blue-400':'text-slate-600'}`;
            });
        };

        window.triggerPintu = () => set(ref(db, "nexhome_v3/states/door"), !state.door);
        window.toggleEco = () => {
            const n = !state.eco_mode;
            const u = { "nexhome_v3/states/eco_mode": n };
            if(n) for(let i=1; i<=8; i++) u[`nexhome_v3/states/relay${i}`] = false;
            update(ref(db), u);
        };

        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString('id-ID', { hour12: false });
        }, 1000);

        onValue(ref(db, ".info/connected"), s => {
            document.getElementById('status-dot').className = s.val() ? "w-2 h-2 rounded-full bg-emerald-500" : "w-2 h-2 rounded-full bg-red-500";
        });
    </script>
</body>
</html>


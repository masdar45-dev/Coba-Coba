<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexHome Masdar - AI Vision Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background: #0b1120; color: #f8fafc; margin: 0; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        #camera-box { 
            position: relative; 
            width: 100%; 
            max-width: 640px; 
            margin: 0 auto; 
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 1.5rem;
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
            overflow: hidden;
            border: 2px solid #334155;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100% !important; 
            height: 100% !important; 
            z-index: 100; 
            pointer-events: none;
        }
        .tab-btn.active { background: #2563eb; color: white; border-color: #3b82f6; }
    </style>
</head>
<body class="pb-10">

    <header class="p-6 max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center shadow-xl shadow-blue-500/20">
                <svg width="24" height="24" fill="white" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
            </div>
            <div>
                <h1 class="text-xl font-black tracking-tight uppercase">NexHome <span class="text-blue-500">Masdar</span></h1>
                <div class="flex items-center gap-2">
                    <div id="hw-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span id="hw-txt" class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Sinkronisasi...</span>
                </div>
            </div>
        </div>

        <!-- Sensor Section -->
        <div class="flex gap-4">
            <div class="glass p-3 rounded-2xl border-l-4 border-l-orange-500 min-w-[100px]">
                <p class="text-[9px] font-bold text-slate-500 uppercase mb-1">üå°Ô∏è Suhu</p>
                <p id="temp-val" class="text-xl font-black">--¬∞C</p>
            </div>
            <div class="glass p-3 rounded-2xl border-l-4 border-l-blue-500 min-w-[100px]">
                <p class="text-[9px] font-bold text-slate-500 uppercase mb-1">üíß Lembab</p>
                <p id="hum-val" class="text-xl font-black">--%</p>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-6">
        <div class="flex bg-slate-900/60 p-1.5 rounded-2xl w-fit mb-8 border border-slate-800">
            <button onclick="tab('ctrl')" id="btn-ctrl" class="tab-btn active px-8 py-2.5 rounded-xl text-[11px] font-black uppercase transition-all">Kontrol</button>
            <button onclick="tab('vis')" id="btn-vis" class="tab-btn px-8 py-2.5 rounded-xl text-[11px] font-black uppercase text-slate-500 transition-all">AI Vision</button>
        </div>

        <!-- Kontrol Tab -->
        <div id="tab-ctrl" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

        <!-- Vision Tab -->
        <div id="tab-vis" class="hidden space-y-6">
            <div id="camera-box">
                <video id="webcam" autoplay muted playsinline></video>
                <canvas id="canvas-overlay"></canvas>
                <div class="absolute top-4 left-4 z-[110]">
                    <div class="glass px-3 py-1.5 rounded-full flex items-center gap-2 border-blue-500/30">
                        <div id="ai-indicator" class="w-1.5 h-1.5 bg-red-500 rounded-full"></div>
                        <span id="ai-status" class="text-[10px] font-black uppercase tracking-tight">AI Memuat...</span>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="glass p-5 rounded-2xl md:col-span-2">
                    <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">Log Analitik</h3>
                    <div id="vision-logs" class="text-[10px] font-mono text-slate-400 h-20 overflow-y-auto space-y-1"></div>
                </div>
                <div class="glass p-5 rounded-2xl flex flex-col items-center justify-center text-center">
                    <p class="text-[10px] font-black text-slate-500 uppercase mb-1">Kecepatan AI</p>
                    <p id="fps-meter" class="text-3xl font-black text-blue-500">0</p>
                    <p class="text-[8px] font-bold text-slate-600 uppercase">Frames/Sec</p>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // URL GitHub Models (Ditambahkan Timestamp untuk menghindari cache lama)
        const MODEL_PATH = "https://raw.githubusercontent.com/masdar45-dev/Coba-Coba/refs/heads/main/models/";

        const fbConfig = {
            apiKey: "AIzaSyCVY-tSDQvob6kYB8-ebLMNVb3Rge1mtx8",
            authDomain: "smart-home-masdar.firebaseapp.com",
            projectId: "smart-home-masdar",
            databaseURL: "https://smart-home-masdar-default-rtdb.asia-southeast1.firebasedatabase.app/" 
        };

        const app = initializeApp(fbConfig);
        const db = getDatabase(app);
        const rootPath = "nexhome_v3";

        let video = document.getElementById('webcam');
        let canvas = document.getElementById('canvas-overlay');
        let ctx = canvas.getContext('2d');
        let aiReady = false;
        let activeTab = 'ctrl';
        let lastFrameTime = 0;

        // TAB SWITCHER
        window.tab = (t) => {
            activeTab = t;
            document.getElementById('tab-ctrl').classList.toggle('hidden', t !== 'ctrl');
            document.getElementById('tab-vis').classList.toggle('hidden', t !== 'vis');
            document.getElementById('btn-ctrl').className = t === 'ctrl' ? 'tab-btn active px-8 py-2.5 rounded-xl text-[11px] font-black uppercase' : 'tab-btn px-8 py-2.5 rounded-xl text-[11px] font-black uppercase text-slate-500';
            document.getElementById('btn-vis').className = t === 'vis' ? 'tab-btn active px-8 py-2.5 rounded-xl text-[11px] font-black uppercase' : 'tab-btn px-8 py-2.5 rounded-xl text-[11px] font-black uppercase text-slate-500';
            
            if(t === 'vis') initVision();
        };

        // FIREBASE HANDLER
        onValue(ref(db, rootPath), (snap) => {
            const data = snap.val() || {};
            
            // Sensor Suhu & Lembab
            document.getElementById('temp-val').innerText = (data.sensors?.temperature || '--') + '¬∞C';
            document.getElementById('hum-val').innerText = (data.sensors?.humidity || '--') + '%';

            // HW Status
            const isOnline = (Date.now() - (data.last_online || 0)) < 15000;
            document.getElementById('hw-dot').className = `w-2 h-2 rounded-full ${isOnline ? 'bg-green-500' : 'bg-red-500'}`;
            document.getElementById('hw-txt').innerText = isOnline ? 'Tersambung' : 'Terputus';

            // Relay Buttons
            const ctrlContainer = document.getElementById('tab-ctrl');
            ctrlContainer.innerHTML = '';
            for(let i=1; i<=8; i++) {
                const id = `relay${i}`;
                const state = data.states?.[id] || false;
                const label = data.names?.[id] || `Saklar ${i}`;
                ctrlContainer.innerHTML += `
                    <div onclick="toggleSwitch('${id}', ${state})" class="glass p-6 rounded-3xl cursor-pointer transition-all active:scale-95 ${state ? 'border-blue-500 shadow-[0_0_20px_rgba(37,99,235,0.2)]' : ''}">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-2xl">${state ? 'üí°' : 'üîå'}</span>
                            <div class="w-1.5 h-1.5 rounded-full ${state ? 'bg-blue-500 animate-pulse' : 'bg-slate-700'}"></div>
                        </div>
                        <p class="text-[11px] font-black text-white uppercase truncate">${label}</p>
                        <p class="text-[9px] font-bold ${state ? 'text-blue-400' : 'text-slate-500'} mt-1 uppercase">${state ? 'Aktif' : 'Mati'}</p>
                    </div>
                `;
            }
        });

        window.toggleSwitch = (id, cur) => set(ref(db, `${rootPath}/states/${id}`), !cur);

        // VISION ENGINE
        async function initVision() {
            if(!video.srcObject) {
                try {
                    addLog("Mengaktifkan Kamera...");
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 640, height: 480, facingMode: "user" } 
                    });
                    video.srcObject = stream;
                    await loadModels();
                } catch(e) {
                    addLog("Kamera Gagal Akses.");
                }
            }
        }

        async function loadModels() {
            try {
                addLog("Mengunduh otak AI dari GitHub...");
                // Menggunakan TinyFaceDetector agar lebih ringan untuk koneksi internet
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_PATH);
                await faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_PATH);
                await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_PATH);
                await faceapi.nets.ageGenderNet.loadFromUri(MODEL_PATH);
                
                aiReady = true;
                document.getElementById('ai-indicator').classList.replace('bg-red-500', 'bg-green-500');
                document.getElementById('ai-status').innerText = "AI ONLINE";
                addLog("AI Berhasil Dimuat.");
                processFrame();
            } catch(e) {
                console.error(e);
                addLog("Gagal Memuat Model AI.");
            }
        }

        async function processFrame() {
            if(!aiReady || activeTab !== 'vis') return;

            // Update FPS
            const now = performance.now();
            const fps = Math.round(1000 / (now - lastFrameTime));
            lastFrameTime = now;
            document.getElementById('fps-meter').innerText = fps;

            // Paksa Canvas mengikuti ukuran Tampilan Video (Penting untuk Label)
            canvas.width = video.clientWidth;
            canvas.height = video.clientHeight;

            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 224, scoreThreshold: 0.5 }))
                .withFaceLandmarks(true)
                .withFaceExpressions()
                .withAgeAndGender();

            const resizedResults = faceapi.resizeResults(detections, { width: canvas.width, height: canvas.height });
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if(resizedResults.length > 0) {
                resizedResults.forEach(result => {
                    const { detection, age, gender, expressions } = result;
                    const box = detection.box;

                    // 1. Gambar Kotak (Futuristik)
                    ctx.strokeStyle = '#2563eb';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(box.x, box.y, box.width, box.height);

                    // 2. Olah Label
                    const topExp = Object.keys(expressions).reduce((a, b) => expressions[a] > expressions[b] ? a : b);
                    const genderIndo = gender === 'male' ? 'PRIA' : 'WANITA';
                    const labelText = `${genderIndo} | ${Math.round(age)}TH | ${topExp.toUpperCase()}`;

                    // 3. Gambar Background Label
                    ctx.font = '900 12px Outfit';
                    const textWidth = ctx.measureText(labelText).width;
                    
                    ctx.fillStyle = '#2563eb';
                    ctx.fillRect(box.x, box.y - 30, textWidth + 20, 30);

                    // 4. Gambar Teks
                    ctx.fillStyle = 'white';
                    ctx.fillText(labelText, box.x + 10, box.y - 10);
                });
            }

            requestAnimationFrame(processFrame);
        }

        function addLog(m) {
            const logs = document.getElementById('vision-logs');
            const d = document.createElement('div');
            d.innerHTML = `<span class="text-blue-500 mr-2">‚óè</span> ${m}`;
            logs.prepend(d);
            if(logs.children.length > 6) logs.lastChild.remove();
        }

        window.onload = () => tab('ctrl');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexHome Masdar V8.1 - Gemini AI with Logs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #0f172a;
            --accent-blue: #3b82f6;
            --accent-emerald: #10b981;
        }
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-color); 
            color: #e5e7eb; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 20px; 
            scroll-behavior: smooth;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 20px;
            font-size: 14px;
            animation: slideUp 0.3s ease-out;
            line-height: 1.6;
            position: relative;
        }

        .message-ai { 
            align-self: flex-start; 
            background: rgba(30, 41, 59, 0.5); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: #f3f4f6; 
            border-bottom-left-radius: 4px;
        }

        .message-user { 
            align-self: flex-end; 
            background: linear-gradient(135deg, #2563eb, #1d4ed8); 
            color: white; 
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        /* Log Panel */
        .log-section {
            height: 180px;
            background: rgba(10, 10, 10, 0.95);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 10px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
        }

        .log-entry {
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            display: flex;
            gap: 8px;
        }

        .log-time { color: #64748b; }
        .log-msg { color: #cbd5e1; }
        .log-tag { color: var(--accent-blue); font-weight: bold; }

        /* Dashboard Fixed */
        .dashboard-fixed {
            background: #0f172a;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .input-bar {
            padding: 12px;
            background: #050505;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .input-box {
            background: #1e293b;
            border-radius: 25px;
            display: flex;
            align-items: center;
            padding: 4px 8px 4px 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        input { background: transparent; border: none; color: white; flex: 1; outline: none; font-size: 14px; padding: 8px 0; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <header class="p-4 flex justify-between items-center border-b border-white/5 bg-black/50 backdrop-blur-md">
        <div>
            <h1 class="text-[10px] font-black tracking-[0.2em] uppercase text-blue-500">NexHome Gemini V8.1</h1>
            <p id="greeting-text" class="text-xs text-zinc-400 font-medium">Sistem Aktif</p>
        </div>
        <div id="conn-indicator" class="flex items-center gap-2 px-3 py-1 rounded-full bg-zinc-900 border border-white/5">
            <div class="w-1.5 h-1.5 rounded-full bg-red-500"></div>
            <span class="text-[9px] font-bold uppercase text-zinc-500">Offline</span>
        </div>
    </header>

    <!-- Chat Area -->
    <div id="chat-box" class="chat-container"></div>

    <!-- Log Aktivitas -->
    <div class="log-section" id="log-container">
        <div class="log-entry"><span class="log-time">[SYSTEM]</span> <span class="log-msg">Menunggu sinkronisasi data...</span></div>
    </div>

    <!-- Sensor Mini Dashboard -->
    <div class="dashboard-fixed">
        <div class="flex flex-col items-center p-2 bg-white/5 rounded-xl border border-white/5">
            <span class="text-[8px] uppercase text-zinc-500 font-bold">Suhu</span>
            <span id="val-temp" class="text-sm font-bold">--°C</span>
        </div>
        <div class="flex flex-col items-center p-2 bg-white/5 rounded-xl border border-white/5">
            <span class="text-[8px] uppercase text-zinc-500 font-bold">Lembab</span>
            <span id="val-hum" class="text-sm font-bold">--%</span>
        </div>
        <div class="flex flex-col items-center p-2 bg-white/5 rounded-xl border border-white/5">
            <span class="text-[8px] uppercase text-zinc-500 font-bold">Pintu</span>
            <span id="val-door" class="text-[10px] font-bold text-emerald-500">AMAN</span>
        </div>
    </div>

    <!-- Input Area -->
    <div class="input-bar">
        <div class="input-box">
            <input type="text" id="user-input" placeholder="Ketik perintah atau tanya status..." autocomplete="off">
            <button id="btn-mic" class="p-2 text-zinc-400">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
            </button>
            <button id="btn-send" class="ml-1 bg-blue-600 p-2 rounded-full text-white">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCVY-tSDQvob6kYB8-ebLMNVb3Rge1mtx8",
            authDomain: "smart-home-masdar.firebaseapp.com",
            projectId: "smart-home-masdar",
            databaseURL: "https://smart-home-masdar-default-rtdb.asia-southeast1.firebasedatabase.app/" 
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const homeRef = ref(db, "nexhome_v3");

        let homeData = { states: {}, sensors: {}, names: {} };
        let isFirstLoad = true;

        // Log Function
        function writeLog(tag, message) {
            const container = document.getElementById('log-container');
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ":" + 
                            now.getMinutes().toString().padStart(2, '0') + ":" + 
                            now.getSeconds().toString().padStart(2, '0');
            
            const div = document.createElement('div');
            div.className = "log-entry";
            div.innerHTML = `<span class="log-time">[${timeStr}]</span> <span class="log-tag">${tag}</span> <span class="log-msg">${message}</span>`;
            container.prepend(div);
        }

        // Firebase Listener
        onValue(homeRef, (snapshot) => {
            const data = snapshot.val();
            if(!data) return;
            homeData = data;
            updateUI();
            
            if(isFirstLoad) {
                writeLog("SYSTEM", "Koneksi database berhasil dibangun.");
                const hour = new Date().getHours();
                let greet = hour < 11 ? "Pagi" : hour < 15 ? "Siang" : hour < 19 ? "Sore" : "Malam";
                document.getElementById('greeting-text').innerText = `Selamat ${greet}, Masdar.`;
                addBubble(`Selamat ${greet}! Gemini NexHome siap membantu Anda mengontrol rumah.`, 'ai');
                isFirstLoad = false;
            }
        });

        onValue(ref(db, ".info/connected"), (s) => {
            const el = document.getElementById('conn-indicator');
            if(s.val()) {
                el.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div><span class="text-[9px] font-bold uppercase text-emerald-500">Online</span>';
                writeLog("NETWORK", "Terhubung ke server Cloud.");
            } else {
                el.innerHTML = '<div class="w-1.5 h-1.5 rounded-full bg-red-500"></div><span class="text-[9px] font-bold uppercase text-zinc-500">Offline</span>';
                writeLog("NETWORK", "Koneksi terputus.");
            }
        });

        function updateUI() {
            const s = homeData.sensors || {};
            const st = homeData.states || {};
            document.getElementById('val-temp').innerText = `${s.temperature || '--'}°C`;
            document.getElementById('val-hum').innerText = `${s.humidity || '--'}%`;
            
            const doorEl = document.getElementById('val-door');
            if(st.door) {
                doorEl.innerText = "TERBUKA";
                doorEl.className = "text-[10px] font-bold text-red-500";
            } else {
                doorEl.innerText = "AMAN";
                doorEl.className = "text-[10px] font-bold text-emerald-500";
            }
        }

        async function handleCommand(text) {
            const input = text.toLowerCase();
            let reply = "";
            let actionTaken = false;

            writeLog("INPUT", `Menerima perintah: "${text}"`);

            if (input.includes("cek") || input.includes("status") || input.includes("keadaan")) {
                const activeRelays = Object.keys(homeData.states).filter(k => k.startsWith('relay') && homeData.states[k]).length;
                reply = `Status: Pintu ${homeData.states.door ? 'Terbuka' : 'Terkunci'}. Suhu ${homeData.sensors.temperature}°C. ${activeRelays} perangkat menyala.`;
                writeLog("AI", "Memberikan laporan status sensor.");
                actionTaken = true;
            }
            else if (input.includes("semua")) {
                const turnOn = input.includes("nyala") || input.includes("hidup") || input.includes("aktif");
                const batch = {};
                for(let i=1; i<=8; i++) batch[`nexhome_v3/states/relay${i}`] = turnOn;
                update(ref(db), batch);
                reply = `Oke, semua perangkat telah saya ${turnOn ? 'nyalakan' : 'matikan'}.`;
                writeLog("ACTION", `Batch update: Semua relay -> ${turnOn}`);
                actionTaken = true;
            }
            else if (input.includes("pintu")) {
                const open = input.includes("buka");
                set(ref(db, "nexhome_v3/states/door"), open);
                reply = open ? "Pintu utama telah dibuka." : "Pintu utama telah dikunci.";
                writeLog("ACTION", `Kunci Pintu -> ${open}`);
                actionTaken = true;
            }
            else {
                for (let i = 1; i <= 8; i++) {
                    const id = `relay${i}`;
                    const name = (homeData.names?.[id] || "").toLowerCase();
                    if (name && input.includes(name)) {
                        const on = input.includes("nyala") || input.includes("hidup") || input.includes("aktif") || (!input.includes("mati") && !input.includes("padam"));
                        set(ref(db, `nexhome_v3/states/${id}`), on);
                        reply = `Siap, ${homeData.names[id]} ${on ? 'dinyalakan' : 'dimatikan'}.`;
                        writeLog("ACTION", `${id} (${name}) -> ${on}`);
                        actionTaken = true;
                        break;
                    }
                }
            }

            if (!actionTaken) {
                reply = "Maaf, saya tidak mengenali perintah tersebut. Coba gunakan kata 'Nyalakan', 'Matikan', atau 'Cek Status'.";
                writeLog("WARN", "Perintah tidak dikenali oleh NLP.");
            }

            setTimeout(() => {
                addBubble(reply, 'ai');
                speak(reply);
            }, 400);
        }

        function addBubble(text, role) {
            const chatBox = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `message message-${role}`;
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function speak(text) {
            if(!window.speechSynthesis) return;
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'id-ID';
            window.speechSynthesis.speak(msg);
        }

        document.getElementById('btn-send').onclick = () => {
            const el = document.getElementById('user-input');
            if(!el.value.trim()) return;
            addBubble(el.value, 'user');
            handleCommand(el.value);
            el.value = "";
        };

        document.getElementById('user-input').onkeypress = (e) => {
            if(e.key === 'Enter') document.getElementById('btn-send').click();
        };

        document.getElementById('btn-mic').onclick = () => {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!Speech) return;
            const rec = new Speech();
            rec.lang = 'id-ID';
            rec.onresult = (e) => {
                const t = e.results[0][0].transcript;
                addBubble(t, 'user');
                handleCommand(t);
            };
            rec.start();
        };

    </script>
</body>
</html>

